--- remaster_generic_inner_chroot_script_after.sh	2013-05-24 08:35:06.709482445 +0300
+++ remaster_generic_inner_chroot_script_after_xfce.sh	2013-05-23 19:36:43.841025623 +0300
@@ -1,98 +1,67 @@
 #!/bin/bash
 
+# do not remove these
 /usr/sbin/env-update
 . /etc/profile
 
-_get_kernel_tag() {
-	local kernel_ver="$(equo match --installed -qv virtual/linux-binary | cut -d/ -f 2)"
-	# strip -r** if exists, hopefully we don't have PN ending with -r
-	local kernel_ver="${kernel_ver%-r*}"
-	local kernel_tag_file="/etc/kernels/${kernel_ver}/RELEASE_LEVEL"
-	if [ ! -f "${kernel_tag_file}" ]; then
-		echo "cannot find ${kernel_tag_file}, wtf" >&2
-	else
-		echo "#$(cat "${kernel_tag_file}")"
-	fi
-}
-
-install_kernel_packages() {
-	local kernel_tag=$(_get_kernel_tag)
-	local pkgs=()
-	for pkg in "${@}"; do
-		pkgs+=( "${pkg}${kernel_tag}" )
-	done
-	equo install "${pkgs[@]}"
-}
-
-sd_enable() {
-	[[ -x /usr/bin/systemctl ]] && \
-		systemctl --no-reload enable -f "${1}.service"
-}
-
-sd_disable() {
-	[[ -x /usr/bin/systemctl ]] && \
-		systemctl --no-reload disable -f "${1}.service"
-}
+splash_manager -c set -t rogentos --tty=1
 
 basic_environment_setup() {
 	eselect opengl set xorg-x11 &> /dev/null
 
+	rc-update del bluetooth
+	rc-update add bluetooth default
+
 	# automatically start xdm
 	rc-update del xdm default
 	rc-update del xdm boot
 	rc-update add xdm boot
-	# systemd has specific targets depending on the DM
+
+	rc-update add rogentoslive boot
+        rc-update add x-setup boot
 
 	# consolekit must be run at boot level
 	rc-update add consolekit boot
-	# systemd uses logind
 
-	rc-update del sabayon-mce default
-	sd_disable sabayon-mce
+	# if it exists
+	if [ -f "/etc/init.d/hald" ]; then
+		rc-update del hald boot
+		rc-update del hald
+		rc-update add hald boot
+	fi
+
+	rc-update del music boot
+	rc-update add music default
+	rc-update del rogentos-mce default
 	rc-update add nfsmount default
 
-	# setup avahi
-	rc-update add avahi-daemon default
-	sd_enable avahi-daemon
-
-	# setup printer
-	rc-update add cupsd default
-	rc-update add cups-browsed default
-	sd_enable cups
-	sd_enable cups-browsed
-
-	local kern_type="$(equo match --installed -q virtual/linux-binary)"
-	local do_zfs=1
-	if [ ! -f /etc/init.d/zfs ]; then
-		do_zfs=0
-	elif [ "$(uname -m)" != "x86_64" ]; then
-		do_zfs=0
-	elif [ "${kern_type}" = "sys-kernel/linux-hardened" ]; then
-		do_zfs=0  # currently not in the hardened kernel
-	fi
-	if [ "${do_zfs}" = "1" ]; then
+	if [ -f /etc/init.d/zfs ] && [ "$(uname -m)" = "x86_64" ]; then
 		rc-update add zfs boot
-		sd_enable zfs
 	fi
 
+	# Always startup this
+	rc-update add virtualbox-guest-additions boot
 	# Create a default "games" group so that
 	# the default user will be added to it during
 	# live boot, and thus, after install.
 	# See bug 3134
 	groupadd -f games
+}
 
-	# all these images come with X.Org
-	sd_enable graphical
+remove_desktop_files() {
+	rm /etc/skel/Desktop/WorldOfGooDemo-world-of-goo-demo.desktop
 }
 
 setup_cpufrequtils() {
 	rc-update add cpufrequtils default
-	sd_enable cpufrequtils
 }
 
 setup_sabayon_mce() {
-	rc-update add sabayon-mce boot
-	sd_enable sabayon-mce
+	rc-update add rogentos-mce boot
+	# not needed, done by app-misc/sabayon-mce pkg
+	# Sabayon Media Center user setup
+	# source /sbin/rogentos-functions.sh
+	# sabayon_setup_live_user "sabayonmce"
 }
 
 switch_kernel() {
@@ -114,33 +83,20 @@
 	# determine what is the login manager
 	if [ -n "$(equo match --installed gnome-base/gdm -qv)" ]; then
 		sed -i 's/DISPLAYMANAGER=".*"/DISPLAYMANAGER="gdm"/g' /etc/conf.d/xdm
-		sd_enable gdm
 	elif [ -n "$(equo match --installed lxde-base/lxdm -qv)" ]; then
 		sed -i 's/DISPLAYMANAGER=".*"/DISPLAYMANAGER="lxdm"/g' /etc/conf.d/xdm
-		sd_enable lxdm
-	elif [ -n "$(equo match --installed x11-misc/lightdm-base -qv)" ]; then
-		sed -i 's/DISPLAYMANAGER=".*"/DISPLAYMANAGER="lightdm"/g' /etc/conf.d/xdm
-		sd_enable lightdm
 	elif [ -n "$(equo match --installed kde-base/kdm -qv)" ]; then
 		sed -i 's/DISPLAYMANAGER=".*"/DISPLAYMANAGER="kdm"/g' /etc/conf.d/xdm
-		sd_enable kdm
 	else
 		sed -i 's/DISPLAYMANAGER=".*"/DISPLAYMANAGER="xdm"/g' /etc/conf.d/xdm
-		sd_enable xdm
 	fi
 }
 
-setup_default_xsession() {
-	local sess="${1}"
-	ln -sf "${sess}.desktop" /usr/share/xsessions/default.desktop
-}
-
 setup_networkmanager() {
 	rc-update del NetworkManager default
 	rc-update del NetworkManager
 	rc-update add NetworkManager default
 	rc-update add NetworkManager-setup default
-	sd_enable NetworkManager
 }
 
 xfceforensic_remove_skel_stuff() {
@@ -164,8 +120,8 @@
 	touch /.enable_kms
 
 	# Remove nouveau from blacklist
-	sed -i ":^blacklist: s:blacklist nouveau:# blacklist nouveau:g" \
-		/etc/modprobe.d/blacklist.conf
+	#sed -i ":^blacklist: s:blacklist nouveau:# blacklist nouveau:g" \
+		#/etc/modprobe.d/blacklist.conf
 }
 
 has_proprietary_drivers() {
@@ -180,52 +136,39 @@
 	return 1
 }
 
-setup_virtualbox() {
-	install_kernel_packages \
-		"app-emulation/virtualbox-guest-additions" \
-		"x11-drivers/xf86-video-virtualbox"
-	rc-update add virtualbox-guest-additions boot
-	sd_enable virtualbox-guest-additions
-}
-
-install_proprietary_gfx_drivers() {
-	install_kernel_packages "x11-drivers/ati-drivers" \
-		"x11-drivers/nvidia-drivers"
-}
-
 setup_proprietary_gfx_drivers() {
-        local myuname=$(uname -m)
-        local mydir="x86"
-        if [ "${myuname}" == "x86_64" ]; then
+	# Prepare NVIDIA legacy drivers infrastructure
+
+	if [ ! -d "/install-data/drivers" ]; then
+		mkdir -p /install-data/drivers
+	fi
+	myuname=$(uname -m)
+	mydir="x86"
+	if [ "$myuname" == "x86_64" ]; then
                 mydir="amd64"
         fi
-        local kernel_tag=$(_get_kernel_tag)
-        local pkgs_dir=/var/lib/entropy/client/packages
-        local cd_dir=/install-data/drivers
-        local pkgs=(
-                "=x11-drivers/nvidia-userspace-304*"
-                "=x11-drivers/nvidia-drivers-304*${kernel_tag}"
-                "=x11-drivers/nvidia-userspace-173*"
-                "=x11-drivers/nvidia-drivers-173*${kernel_tag}"
-        )
-        local ts=
-        local tp=
-        local pkg_f=
-
-        mkdir -p "${cd_dir}" || return 1
-        equo download --nodeps "${pkgs[@]}" || return 1
-
-        OLDIFS=${IFS}
-        IFS='
-'
-        local data=( $(equo match --quiet --showdownload "${pkgs[@]}") )
-        IFS=${OLDIFS}
-        for ts in "${data[@]}"; do
-                tp=( ${ts} )
-                pkg_f="${pkgs_dir}/${tp[1]}"
-                echo "Copying ${pkg_f} to ${cd_dir}"
-                cp "${pkg_f}" "${cd_dir}"/
-        done
+	kernel_ver="$(equo match --installed -qv virtual/linux-binary | cut -d/ -f 2)"
+	# strip -r** if exists, hopefully we don't have PN ending with -r
+	kernel_ver="${kernel_ver%-r*}"
+	kernel_tag_file="/etc/kernels/${kernel_ver}/RELEASE_LEVEL"
+	if [ ! -f "${kernel_tag_file}" ]; then
+		echo "cannot find ${kernel_tag_file}, wtf" >&2
+		# do not return 1 !!!
+		return 0
+	fi
+	kernel_tag="#$(cat "${kernel_tag_file}")"
+
+	rm -rf /var/lib/entropy/client/packages/packages*/${mydir}/*/x11-drivers*
+	# dead with >=xorg-server-1.11
+	# ACCEPT_LICENSE="NVIDIA" equo install --fetch --nodeps =x11-drivers/nvidia-drivers-173*$kernel_tag
+	# ACCEPT_LICENSE="NVIDIA" equo install --fetch --nodeps =x11-drivers/nvidia-drivers-96.43.20*$kernel_tag
+	## not working with >=xorg-server-1.5
+	## ACCEPT_LICENSE="NVIDIA" equo install --fetch --nodeps ~x11-drivers/nvidia-drivers-71.86.*$kernel_tag
+	# mv /var/lib/entropy/client/packages/packages-nonfree/${mydir}/*/x11-drivers\:nvidia-drivers*.tbz2 /install-data/drivers/
+
+	# if we ship with ati-drivers, we have KMS disabled by default.
+	# and better set driver arch to classic
+	eselect mesa set r600 classic
 }
 
 setup_gnome_shell_extensions() {
@@ -249,7 +192,6 @@
 		20-unhint-small-dejavu-sans-mono.conf
 		20-unhint-small-dejavu-serif.conf
 		31-cantarell.conf
-		52-infinality.conf
 		57-dejavu-sans.conf
 		57-dejavu-sans-mono.conf
 		57-dejavu-serif.conf"
@@ -261,9 +203,6 @@
 			echo "ouch, /etc/fonts/conf.avail/${fc_en} is not available" >&2
 		fi
 	done
-	# Complete infinality setup
-	eselect infinality set infinality
-	eselect lcdfilter set infinality
 }
 
 setup_misc_stuff() {
@@ -294,21 +233,81 @@
 		rm $file
 	done
 
+	# Setup basic GTK theme for root user
+	if [ ! -f "/root/.gtkrc-2.0" ]; then
+		echo "include \"/usr/share/themes/Clearlooks/gtk-2.0/gtkrc\"" > /root/.gtkrc-2.0
+	fi
 	# Regenerate Fluxbox menu
 	if [ -x "/usr/bin/fluxbox-generate_menu" ]; then
 		fluxbox-generate_menu -o /etc/skel/.fluxbox/menu
+		elif [ ! -d "/etc/skel/.fluxbox/menu" ]; then
+		echo "It didn't work the first time, doing it again + chown"
+			fluxbox_generate_menu -o /etc/skel/.fluxbox/menu
+			chown rogentosuser /etc/skel/.fluxbox/
+		echo "Fixing the fluxbox problem once and for all"
+		elif [ -d "/home/rogentosuser/" ]; then
+			echo "this was created, so we do chown"
+			chown rogentosuser /home/rogentosuser/
 	fi
 }
 
+rogentos_splash() {
+if [ -d "/etc/splash/sabayon" ]; then
+        rm -r /etc/splash/sabayon
+        ln -s /etc/splash/rogentos /etc/splash/sabayon
+        echo "So etc/splash/sabayon exists"
+        ln -s /etc/splash/rogentos /etc/splash/sabayon
+
+        for i in `seq 1 6`; do
+        splash_manager -c set -t rogentos --tty=$i
+        done
+fi
+}
+
+rogentos_install() {
+
+#Rogentos ISO Remaking from the Beginnings
+
+localz=$(pwd)
+ARCH=$(uname -m)
+rog=rogentos-artwork
+
+echo "Entering folder $localz"
+equo remove anaconda --nodeps
+
+if [ "$ARCH" = "x86_64" ]; then
+		equo unmask anaconda
+		equo install anaconda --nodeps
+		echo "installed rogentos artwork amd64"
+		echo -5 | equo conf update
+		depmod -a
+		env-update && source /etc/profile
+		rogentos_splash
+	else
+		equo unmask anaconda
+		equo install anaconda --nodeps
+		echo "Installed rogentos artwork x86"
+		echo -5 | equo conf update
+		depmod -a
+		env-update && source /etc/profile
+		rogentos_splash
+fi
+
+equo mask linux-sabayon virtualbox-guest-additions broadcom-sta ndiswrapper
+echo "Se va folosi kernel-schimbare pentru schimbarea nucleului"
+}
+
 setup_installed_packages() {
+	rogentos_install
 	# Update package list
-	equo query list installed -qv > /etc/sabayon-pkglist
+	equo query list installed -qv > /etc/rogentos-pkglist
 	echo -5 | equo conf update
 
 	echo "Vacuum cleaning client db"
 	rm /var/lib/entropy/client/database/*/sabayonlinux.org -rf
 	rm /var/lib/entropy/client/database/*/sabayon-weekly -rf
 	rm /var/lib/entropy/client/database/*/rogentoslinux -rf
+	rm /var/lib/entropy/client/database/*/rogentos -rf
 	equo rescue vacuum
 
 	# restore original repositories.conf (all mirrors were filtered for speed)
@@ -323,11 +322,15 @@
 	rm -rf /var/lib/entropy/*cache*
 	# remove entropy pid file
 	rm -f /var/run/entropy/entropy.lock
-	rm -f /var/lib/entropy/entropy.pid
-	rm -f /var/lib/entropy/entropy.lock
 }
 
 setup_portage() {
+	layman -d sabayon
+	rm -rf /var/lib/layman/sabayon
+	layman -d sabayon-distro
+	rm -rf /var/lib/layman/sabayon-distro
+	layman -d rogento
+	rm -rf /var/lib/layman/rogento
 	emaint --fix world
 }
 
@@ -343,13 +346,11 @@
 }
 
 prepare_lxde() {
-	install_proprietary_gfx_drivers
-	setup_virtualbox
 	setup_networkmanager
 	# Fix ~/.dmrc to have it load LXDE
 	echo "[Desktop]" > /etc/skel/.dmrc
 	echo "Session=LXDE" >> /etc/skel/.dmrc
-	setup_default_xsession "LXDE"
+	remove_desktop_files
 	setup_displaymanager
 	# properly tweak lxde autostart tweak, adding --desktop option
 	sed -i 's/pcmanfm -d/pcmanfm -d --desktop/g' /etc/xdg/lxsession/LXDE/autostart
@@ -358,49 +359,12 @@
 	has_proprietary_drivers && setup_proprietary_gfx_drivers || setup_oss_gfx_drivers
 }
 
-prepare_mate() {
-	install_proprietary_gfx_drivers
-	setup_virtualbox
-	setup_networkmanager
-	# Fix ~/.dmrc to have it load MATE
-	echo "[Desktop]" > /etc/skel/.dmrc
-	echo "Session=mate" >> /etc/skel/.dmrc
-	setup_default_xsession "mate"
-	setup_displaymanager
-	remove_mozilla_skel_cruft
-	setup_cpufrequtils
-	has_proprietary_drivers && setup_proprietary_gfx_drivers || setup_oss_gfx_drivers
-}
-
-prepare_e17() {
-	install_proprietary_gfx_drivers
-	setup_virtualbox
-	setup_networkmanager
-	# Fix ~/.dmrc to have it load E17
-	echo "[Desktop]" > /etc/skel/.dmrc
-	echo "Session=enlightenment" >> /etc/skel/.dmrc
-	setup_default_xsession "enlightenment"
-	# E17 spin has chromium installed
-	setup_displaymanager
-	# Not using lxdm for now
-	# TODO: improve the lines below
-	# Make sure enlightenment is selected in lxdm
-	# sed -i '/lxdm-greeter-gtk/ a\\nlast_session=enlightenment.desktop\nlast_lang=' /etc/lxdm/lxdm.conf
-	# Fix ~/.gtkrc-2.0 for some nice icons in gtk
-	echo 'gtk-icon-theme-name="Tango" gtk-theme-name="Xfce"' | tr " " "\n" > /etc/skel/.gtkrc-2.0
-	remove_mozilla_skel_cruft
-	setup_cpufrequtils
-	has_proprietary_drivers && setup_proprietary_gfx_drivers || setup_oss_gfx_drivers
-}
-
 prepare_xfce() {
-	install_proprietary_gfx_drivers
-	setup_virtualbox
 	setup_networkmanager
 	# Fix ~/.dmrc to have it load Xfce
 	echo "[Desktop]" > /etc/skel/.dmrc
 	echo "Session=xfce" >> /etc/skel/.dmrc
-	setup_default_xsession "xfce"
+	remove_desktop_files
 	remove_mozilla_skel_cruft
 	setup_cpufrequtils
 	setup_displaymanager
@@ -408,13 +372,11 @@
 }
 
 prepare_fluxbox() {
-	install_proprietary_gfx_drivers
-	setup_virtualbox
 	setup_networkmanager
 	# Fix ~/.dmrc to have it load Fluxbox
 	echo "[Desktop]" > /etc/skel/.dmrc
 	echo "Session=fluxbox" >> /etc/skel/.dmrc
-	setup_default_xsession "fluxbox"
+	remove_desktop_files
 	setup_displaymanager
 	remove_mozilla_skel_cruft
 	setup_cpufrequtils
@@ -422,36 +384,28 @@
 }
 
 prepare_gnome() {
-	install_proprietary_gfx_drivers
-	setup_virtualbox
 	setup_networkmanager
 	# Fix ~/.dmrc to have it load GNOME or Cinnamon
 	echo "[Desktop]" > /etc/skel/.dmrc
 	if [ -f "/usr/share/xsessions/cinnamon.desktop" ]; then
 		echo "Session=cinnamon" >> /etc/skel/.dmrc
-	setup_default_xsession "cinnamon"
 	else
 		echo "Session=gnome" >> /etc/skel/.dmrc
 		setup_gnome_shell_extensions
-	setup_default_xsession "gnome"
 	fi
 	rc-update del system-tools-backends boot
 	rc-update add system-tools-backends default
-	# no systemd counterpart
-
 	setup_displaymanager
 	setup_sabayon_mce
-	setup_cpufrequtils
 	has_proprietary_drivers && setup_proprietary_gfx_drivers || setup_oss_gfx_drivers
 }
 
 prepare_xfceforensic() {
-	install_proprietary_gfx_drivers
 	setup_networkmanager
 	# Fix ~/.dmrc to have it load Xfce
 	echo "[Desktop]" > /etc/skel/.dmrc
 	echo "Session=xfce" >> /etc/skel/.dmrc
-	setup_default_xsession "xfce"
+	remove_desktop_files
 	setup_cpufrequtils
 	setup_displaymanager
 	remove_mozilla_skel_cruft
@@ -460,17 +414,10 @@
 }
 
 prepare_kde() {
-	install_proprietary_gfx_drivers
-	setup_virtualbox
 	setup_networkmanager
 	# Fix ~/.dmrc to have it load KDE
 	echo "[Desktop]" > /etc/skel/.dmrc
 	echo "Session=KDE-4" >> /etc/skel/.dmrc
-	setup_default_xsession "KDE-4"
-	# Configure proper GTK3 theme
-	# TODO: find a better solution?
-	mv /etc/skel/.config/gtk-3.0/settings.ini._kde_molecule \
-		/etc/skel/.config/gtk-3.0/settings.ini
 	setup_displaymanager
 	setup_sabayon_mce
 	setup_cpufrequtils
@@ -478,13 +425,11 @@
 }
 
 prepare_awesome() {
-	install_proprietary_gfx_drivers
-	setup_virtualbox
 	setup_networkmanager
 	# Fix ~/.dmrc to have it load Awesome
 	echo "[Desktop]" > /etc/skel/.dmrc
 	echo "Session=awesome" >> /etc/skel/.dmrc
-	setup_default_xsession "awesome"
+	remove_desktop_files
 	setup_displaymanager
 	remove_mozilla_skel_cruft
 	setup_cpufrequtils
@@ -495,8 +440,6 @@
 	local de="${1}"
 	if [ "${de}" = "lxde" ]; then
 		prepare_lxde
-        elif [ "${de}" = "mate" ]; then
-                prepare_mate
 	elif [ "${de}" = "e17" ]; then
 		prepare_e17
 	elif [ "${de}" = "xfce" ]; then
